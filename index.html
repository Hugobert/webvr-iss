<html>
	<head>
		<title>WebVR ISS</title>
		<script src="https://aframe.io/releases/0.7.1/aframe.min.js"></script>
		<script src="https://unpkg.com/aframe-event-set-component@3.0.3/dist/aframe-event-set-component.min.js"></script>
		<script src="https://code.jquery.com/jquery-1.10.2.js"></script> <!-- for JSON parsing -->
	</head>
	<body>

    <!-- All JS is in an external file for convenience -->
		<script src="js/iss.js"></script>

		<a-scene enter-vr="document.getElementById('camera').setAttribute('position','0 -0.3 89.6');" exit-vr="document.getElementById('camera').setAttribute('position','0 -0.7 89.6');">
      <!-- This is the Asset Manager: Textures, models, sounds, etc... -->
			<a-assets>
        <img id="sky" src="res/starmap.jpg">
				<img id="earth-day" src="res/earth_daymap.jpg">
				<img id="earth-clouds" src="res/earth_clouds.png">
				<!--<img id="sun" src="iss-img/2k_sun.jpg">-->
				<a-asset-item id="cupola-iva" src="res/cupola/scene.gltf">
			</a-assets>

			<a-sky src="#sky"></a-sky>
			<a-entity light="type: ambient; color: #CCC; intensity:0.5"></a-entity>
			<a-sphere id="sun" radius="5" material="color: #FFF" position="-800 0 0" light="type:point"></a-sphere>

			<a-entity id="earth_orbit">
				<a-sphere id="earth" radius=80 material="src: #earth-day; roughness:0.8" position="0 0 0" segments-height="180" segments-width="180">
					<a-sphere id="clouds" radius="81" material="src: #earth-clouds; roughness:1; opacity:0.4" position="0 0 0" segments-height="180" segments-width="180"></a-sphere>
					<a-entity id="iss_orbit" position="0 0 0" rotation="0 90 0">
						<a-animation
							id="iss_orbit_animation"
							easing="linear"
							dur="5000"
							from="0 90 0"
							to="0 90 0"
							repeat="indefinite"
						></a-animation>

						<!-- Camera must be child of model, else camera rotation will also affect model. Weird rotation due to the weird model. It does the job. -->
						<a-gltf-model id="cupola-model" src="#cupola-iva" position="0 0 86" rotation="0 180 0" visible="true"></a-gltf-model>
						<a-cylinder id="button" position="0.160 0.210 89.250" rotation="-96.94 0 0" scale="0.05 0.05 0.05" material="" hide-model></a-cylinder>
						<a-camera wasd-controls="enabled: false"  camera="userHeight: 0.82; far: 10000000000000" id="camera" rotation="0 0 0" position="0 -0.3 89.6" >
							<a-entity cursor="fuse: true; fuseTimeout: 500"
								position="0 0 -0.35"
								geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.015"
								material="color: gray; shader: flat">
								<a-animation begin="cursor-fusing" easing="ease-in" attribute="scale" dur="1000" fill="backwards" from="1 1 1" to="0.1 0.1 0.1"></a-animation>
							</a-entity>
						</a-camera>



					</a-entity>
				</a-sphere>
			</a-entity>

		</a-scene>

		<script>
			// Get time and set earth rotation. Currently, this only happens once, but should happen maybe once a minute.
			time();
			// Get telemetry once. Is probably redundant because we want to do this right at the start.
			telemetry();
			// Update telemetry every 5 seconds. Is probably still too often, but increasing this will result in longer preparation time in the beginning. Gotta fix this.
			setInterval(telemetry,5000);

			AFRAME.registerComponent('hide-model', {
				schema: {
					color: {default: 'red'}
				},

				init: function () {
					var model = document.getElementById("cupola-model");

					document.getElementById("button").addEventListener('click', function () {
						if(model.getAttribute("visible")==true){
							console.log("Hide model");
							model.setAttribute("visible", false);
						} else {
							console.log("Show model");
							model.setAttribute("visible", true);
						}
					});
				}
			});
		</script>

	</body>
</html>
